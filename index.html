<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FM Hi-Hat Playground</title>
  <script src="https://cdn.jsdelivr.net/npm/tone@latest/build/Tone.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .controls {
      margin-top: 20px;
    }
    .control-group {
      margin-bottom: 15px;
    }
    label {
      display: inline-block;
      width: 160px;
    }
    input[type=range] {
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>FM Hi-Hat Playground</h1>
  <button id="startBtn">Start Hi-Hat Loop</button>
  <button id="stopBtn">Stop Hi-Hat Loop</button>
  <button id="noteC6">Set Note: C6</button>
  <button id="noteC7">Set Note: C7</button>

  <div class="controls">
    <h2>Synth Parameters</h2>

    <div class="control-group">
      <label for="volume">Volume:</label>
      <input id="volume" type="range" min="0" max="1" step="0.01" value="0.5">
      <span id="volumeVal">0.5</span>
    </div>

    <div class="control-group">
      <label for="harmonicity">Harmonicity:</label>
      <input id="harmonicity" type="range" min="0" max="16" step="0.1" value="8">
      <span id="harmonicityVal">8</span>
    </div>

    <div class="control-group">
      <label for="modIndex">Modulation Index:</label>
      <input id="modIndex" type="range" min="0" max="32" step="0.1" value="16">
      <span id="modIndexVal">32</span>
    </div>

    <h3>Carrier Envelope</h3>
    <div class="control-group">
      <label for="carrierAttack">Attack:</label>
      <input id="carrierAttack" type="range" min="0.001" max="0.5" step="0.001" value="0.001">
      <span id="carrierAttackVal">0.001</span>
    </div>
    <div class="control-group">
      <label for="carrierDecay">Decay:</label>
      <input id="carrierDecay" type="range" min="0.05" max="0.5" step="0.001" value="0.249">
      <span id="carrierDecayVal">0.249</span>
    </div>

    <h3>Modulation Envelope</h3>
    <div class="control-group">
      <label for="modAttack">Attack:</label>
      <input id="modAttack" type="range" min="0.001" max="0.5" step="0.001" value="0.001">
      <span id="modAttackVal">0.001</span>
    </div>
    <div class="control-group">
      <label for="modDecay">Decay:</label>
      <input id="modDecay" type="range" min="0.05" max="0.5" step="0.001" value="0.249">
      <span id="modDecayVal">0.249</span>
    </div>
  </div>

  <script>
    // Default note is now C7
    let currentNote = "C7";

    // Create FM synth with updated defaults
    const metallicFM = new Tone.FMSynth({
      harmonicity: 8,
      modulationIndex: 32,
      oscillator: { type: "square" },
      envelope: {
        attack: 0.001,
        decay: 0.249,
        sustain: 0,
        release: 0
      },
      modulation: { type: "square" },
      modulationEnvelope: {
        attack: 0.001,
        decay: 0.249,
        sustain: 0,
        release: 0
      }
    });

    // Gain node for amplitude control
    const gainNode = new Tone.Gain(0.5);

    // High-pass filter
    const hpFilter = new Tone.Filter({
      type: "highpass",
      frequency: 6000,
      Q: 1
    }).toDestination();

    // Signal chain: FM synth -> gain -> filter -> output
    metallicFM.connect(gainNode);
    gainNode.connect(hpFilter);

    // Trigger hi-hat
    function triggerHiHat(time) {
      metallicFM.triggerAttackRelease(currentNote, "16n", time);
    }

    // Start Transport
    document.getElementById("startBtn").addEventListener("click", async () => {
      await Tone.start();
      console.log("Audio started");

      Tone.Transport.scheduleRepeat((time) => {
        triggerHiHat(time);
      }, "4n");

      Tone.Transport.start();
    });

    // Stop Transport
    document.getElementById("stopBtn").addEventListener("click", () => {
      Tone.Transport.stop();
      Tone.Transport.cancel();
      console.log("Hi-Hat loop stopped");
    });

    // Note buttons
    document.getElementById("noteC6").addEventListener("click", () => {
      currentNote = "C6";
    });
    document.getElementById("noteC7").addEventListener("click", () => {
      currentNote = "C7";
    });

    // Sliders
    document.getElementById("volume").addEventListener("input", (e) => {
      gainNode.gain.value = parseFloat(e.target.value);
      document.getElementById("volumeVal").textContent = e.target.value;
    });

    document.getElementById("harmonicity").addEventListener("input", (e) => {
      metallicFM.harmonicity.value = parseFloat(e.target.value);
      document.getElementById("harmonicityVal").textContent = e.target.value;
    });

    document.getElementById("modIndex").addEventListener("input", (e) => {
      metallicFM.modulationIndex.value = parseFloat(e.target.value);
      document.getElementById("modIndexVal").textContent = e.target.value;
    });

    document.getElementById("carrierAttack").addEventListener("input", (e) => {
      metallicFM.envelope.attack = parseFloat(e.target.value);
      document.getElementById("carrierAttackVal").textContent = e.target.value;
    });

    document.getElementById("carrierDecay").addEventListener("input", (e) => {
      metallicFM.envelope.decay = parseFloat(e.target.value);
      document.getElementById("carrierDecayVal").textContent = e.target.value;
    });

    document.getElementById("modAttack").addEventListener("input", (e) => {
      metallicFM.modulationEnvelope.attack = parseFloat(e.target.value);
      document.getElementById("modAttackVal").textContent = e.target.value;
    });

    document.getElementById("modDecay").addEventListener("input", (e) => {
      metallicFM.modulationEnvelope.decay = parseFloat(e.target.value);
      document.getElementById("modDecayVal").textContent = e.target.value;
    });
  </script>
</body>
</html>
