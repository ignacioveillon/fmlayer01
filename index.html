<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Hi-Hat with Tone.js</title>
  <script src="https://unpkg.com/tone@14.8.39/build/Tone.js"></script>
</head>
<body style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;font-family:sans-serif;">
  <h1>Open Hi-Hat Synth (Tone.js)</h1>
  <div style="display:flex;gap:1em;flex-wrap:wrap;justify-content:center;">
    <button id="start" style="padding:1em 2em;font-size:1.2em;cursor:pointer;">Start Hi-Hat Loop</button>
    <button id="stop" style="padding:1em 2em;font-size:1.2em;cursor:pointer;">Stop Hi-Hat Loop</button>
    <button id="muteNoise" style="padding:1em 2em;font-size:1.2em;cursor:pointer;">Mute Noise</button>
    <button id="unmuteNoise" style="padding:1em 2em;font-size:1.2em;cursor:pointer;">Unmute Noise</button>
    <button id="muteFM" style="padding:1em 2em;font-size:1.2em;cursor:pointer;">Mute FM</button>
    <button id="unmuteFM" style="padding:1em 2em;font-size:1.2em;cursor:pointer;">Unmute FM</button>
  </div>

  <script>
    Tone.Transport.bpm.value = 140;

    // Open hi-hat noise synth
    const openHiHat = new Tone.NoiseSynth({
      noise: { type: "white" },
      envelope: {
        attack: 0.01,
        decay: 0.4,
        sustain: 0,
        release: 0,
        attackCurve: "exponential",
        decayCurve: "exponential"
      },
    });

    // Metallic FM oscillator
    const metallicOsc = new Tone.FMSynth({
      harmonicity: 5.0,
      modulationIndex: 20,
      oscillator: { type: "square" },
      envelope: {
        attack: 0.01,
        decay: 0.4,
        sustain: 0,
        release: 0,
        attackCurve: "exponential",
        decayCurve: "exponential"
      },
      modulation: { type: "square" },
      modulationEnvelope: {
        attack: 0.01,
        decay: 0.4,
        sustain: 0,
        release: 0,
        attackCurve: "exponential",
        decayCurve: "exponential"
      }
    });

    // Highpass filter to shape tone
    const hpFilter = new Tone.Filter({
      type: "highpass",
      frequency: 6000,
      Q: 1,
    }).toDestination();

    // Connect synths to filter
    openHiHat.connect(hpFilter);
    metallicOsc.connect(hpFilter);

    // Keep track of mute state
    let noiseMuted = false;
    let fmMuted = false;

    // Function to trigger open hi-hat
    function triggerOpenHiHat(time = Tone.now()) {
      if (!noiseMuted) openHiHat.triggerAttackRelease("16n", time);
      if (!fmMuted) metallicOsc.triggerAttackRelease("16n", "C6", time);
    }

    // Play open hi-hat only on upbeats (the "&")
    Tone.Transport.scheduleRepeat((time) => {
      triggerOpenHiHat(time);
    }, "4n", "8n");

    // Start / Stop buttons
    document.querySelector("#start").addEventListener("click", async () => {
      await Tone.start();
      Tone.Transport.start();
      console.log("Hi-hat loop started at 140 BPM!");
    });

    document.querySelector("#stop").addEventListener("click", () => {
      Tone.Transport.stop();
      openHiHat.triggerRelease();
      metallicOsc.triggerRelease();
      console.log("Hi-hat loop stopped.");
    });

    // Mute / Unmute Noise
    document.querySelector("#muteNoise").addEventListener("click", () => { noiseMuted = true; });
    document.querySelector("#unmuteNoise").addEventListener("click", () => { noiseMuted = false; });

    // Mute / Unmute FM
    document.querySelector("#muteFM").addEventListener("click", () => { fmMuted = true; });
    document.querySelector("#unmuteFM").addEventListener("click", () => { fmMuted = false; });
  </script>
</body>
</html>
